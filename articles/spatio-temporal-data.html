<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with Spatio-Temporal Data • chap.r.sdk</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with Spatio-Temporal Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">chap.r.sdk</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/knutdrand/chap_r_sdk/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Working with Spatio-Temporal Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/knutdrand/chap_r_sdk/blob/main/vignettes/spatio-temporal-data.Rmd" class="external-link"><code>vignettes/spatio-temporal-data.Rmd</code></a></small>
      <div class="d-none name"><code>spatio-temporal-data.Rmd</code></div>
    </div>

    
    
<p>This tutorial shows how to work with spatio-temporal data in CHAP
models using established R packages. Rather than reinventing the wheel,
we leverage the excellent tidyverse ecosystem.</p>
<div class="section level2">
<h2 id="recommended-packages">Recommended Packages<a class="anchor" aria-label="anchor" href="#recommended-packages"></a>
</h2>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Package</th>
<th>Purpose</th>
<th>Install</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>tsibble</strong></td>
<td>Temporal data structures</td>
<td><code>install.packages("tsibble")</code></td>
</tr>
<tr class="even">
<td><strong>fabletools</strong></td>
<td>Temporal aggregation, reconciliation</td>
<td><code>install.packages("fabletools")</code></td>
</tr>
<tr class="odd">
<td><strong>sf</strong></td>
<td>Spatial data and operations</td>
<td><code>install.packages("sf")</code></td>
</tr>
<tr class="even">
<td><strong>cubble</strong></td>
<td>Spatio-temporal data wrangling</td>
<td><code>install.packages("cubble")</code></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/knutdrand/chap_r_sdk" class="external-link">chap.r.sdk</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tsibble.tidyverts.org" class="external-link">tsibble</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="working-with-chap-example-data">Working with CHAP Example Data<a class="anchor" aria-label="anchor" href="#working-with-chap-example-data"></a>
</h2>
<p>Let’s start with the example data from the SDK:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_example_data.html">get_example_data</a></span><span class="op">(</span><span class="st">'laos'</span>, <span class="st">'M'</span><span class="op">)</span></span>
<span><span class="va">training_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">training_data</span></span>
<span></span>
<span><span class="co"># Examine the structure</span></span>
<span><span class="va">training_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 1,057 x 13 [1M]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:       location [7]</span></span></span>
<span><span class="co">#&gt;     ...1 time_period rainfall mean_temperature disease_cases population parent</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;mth&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     0    2000 Jul   430.               23.4             0     <span style="text-decoration: underline;">58</span>503. -     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1    2000 Aug   322.               23.8             0     <span style="text-decoration: underline;">58</span>503. -     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     2    2000 Sep   265.               22.7             0     <span style="text-decoration: underline;">58</span>503. -     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     3    2000 Oct   103.               22.6             0     <span style="text-decoration: underline;">58</span>503. -     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     4    2000 Nov    19.7              20.3             0     <span style="text-decoration: underline;">58</span>503. -     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     5    2000 Dec    26.0              19.1             0     <span style="text-decoration: underline;">58</span>503. -     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     6    2001 Jan    17.6              19.8             0     <span style="text-decoration: underline;">60</span>157. -     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     7    2001 Feb     7.28             22.0             0     <span style="text-decoration: underline;">60</span>157. -     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     8    2001 Mar   123.               22.6             0     <span style="text-decoration: underline;">60</span>157. -     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     9    2001 Apr    29.6              27.5             0     <span style="text-decoration: underline;">60</span>157. -     </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,047 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 more variables: location &lt;chr&gt;, Cases &lt;dbl&gt;, E &lt;dbl&gt;, month &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ID_year &lt;dbl&gt;, ID_spat &lt;chr&gt;</span></span></span></code></pre></div>
<p>The data is already a tsibble with: - <code>time_period</code> as the
temporal index (monthly) - <code>location</code> as the spatial key -
<code>disease_cases</code> as the target variable - Various covariates
(rainfall, temperature, population)</p>
</div>
<div class="section level2">
<h2 id="temporal-operations-with-tsibble">Temporal Operations with tsibble<a class="anchor" aria-label="anchor" href="#temporal-operations-with-tsibble"></a>
</h2>
<div class="section level3">
<h3 id="lag-features">Lag Features<a class="anchor" aria-label="anchor" href="#lag-features"></a>
</h3>
<p>Create lagged versions of variables for time series modeling:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add lagged disease cases (1 and 2 months ago)</span></span>
<span><span class="va">training_with_lags</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/group_by_key.html" class="external-link">group_by_key</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    cases_lag1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    cases_lag2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    rainfall_lag1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">rainfall</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">training_with_lags</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_period</span>, <span class="va">location</span>, <span class="va">disease_cases</span>, <span class="va">cases_lag1</span>, <span class="va">cases_lag2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 10 x 5 [1M]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:       location [1]</span></span></span>
<span><span class="co">#&gt;    time_period location disease_cases cases_lag1 cases_lag2</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;mth&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    2000 Jul Bokeo                0         <span style="color: #BB0000;">NA</span>         <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    2000 Aug Bokeo                0          0         <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    2000 Sep Bokeo                0          0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    2000 Oct Bokeo                0          0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    2000 Nov Bokeo                0          0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    2000 Dec Bokeo                0          0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    2001 Jan Bokeo                0          0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    2001 Feb Bokeo                0          0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    2001 Mar Bokeo                0          0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    2001 Apr Bokeo                0          0          0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="rolling-window-statistics">Rolling Window Statistics<a class="anchor" aria-label="anchor" href="#rolling-window-statistics"></a>
</h3>
<p>Calculate moving averages and other rolling statistics using the
slider package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rolling mean of disease cases (3-month window)</span></span>
<span><span class="va">training_with_rolling</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/group_by_key.html" class="external-link">group_by_key</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    cases_ma3 <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html" class="external-link">slide_dbl</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="va">mean</span>, .before <span class="op">=</span> <span class="fl">2</span>, .complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    cases_max3 <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html" class="external-link">slide_dbl</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="va">max</span>, .before <span class="op">=</span> <span class="fl">2</span>, .complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">training_with_rolling</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_period</span>, <span class="va">location</span>, <span class="va">disease_cases</span>, <span class="va">cases_ma3</span>, <span class="va">cases_max3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">location</span> <span class="op">==</span> <span class="st">"Bokeo"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 10 x 5 [1M]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:       location [1]</span></span></span>
<span><span class="co">#&gt;    time_period location disease_cases cases_ma3 cases_max3</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;mth&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    2000 Jul Bokeo                0        <span style="color: #BB0000;">NA</span>         <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    2000 Aug Bokeo                0        <span style="color: #BB0000;">NA</span>         <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    2000 Sep Bokeo                0         0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    2000 Oct Bokeo                0         0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    2000 Nov Bokeo                0         0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    2000 Dec Bokeo                0         0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    2001 Jan Bokeo                0         0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    2001 Feb Bokeo                0         0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    2001 Mar Bokeo                0         0          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    2001 Apr Bokeo                0         0          0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="differencing">Differencing<a class="anchor" aria-label="anchor" href="#differencing"></a>
</h3>
<p>Remove trends with differencing:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_diff</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/group_by_key.html" class="external-link">group_by_key</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    cases_diff <span class="op">=</span> <span class="fu"><a href="https://tsibble.tidyverts.org/reference/difference.html" class="external-link">difference</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    cases_diff12 <span class="op">=</span> <span class="fu"><a href="https://tsibble.tidyverts.org/reference/difference.html" class="external-link">difference</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">12</span><span class="op">)</span>  <span class="co"># Seasonal difference</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">training_diff</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_period</span>, <span class="va">location</span>, <span class="va">disease_cases</span>, <span class="va">cases_diff</span>, <span class="va">cases_diff12</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">location</span> <span class="op">==</span> <span class="st">"Bokeo"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 15 x 5 [1M]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:       location [1]</span></span></span>
<span><span class="co">#&gt;    time_period location disease_cases cases_diff cases_diff12</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;mth&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    2000 Jul Bokeo                0         <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    2000 Aug Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    2000 Sep Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    2000 Oct Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    2000 Nov Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    2000 Dec Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    2001 Jan Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    2001 Feb Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    2001 Mar Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    2001 Apr Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>    2001 May Bokeo                0          0           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>    2001 Jun Bokeo                1          1           <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>    2001 Jul Bokeo                1          0            1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>    2001 Aug Bokeo                1          0            1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>    2001 Sep Bokeo                1          0            1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="handling-missing-values">Handling Missing Values<a class="anchor" aria-label="anchor" href="#handling-missing-values"></a>
</h3>
<p>tsibble provides tools for gap detection and filling:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check for gaps in the time series</span></span>
<span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/has_gaps.html" class="external-link">has_gaps</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 × 2</span></span></span>
<span><span class="co">#&gt;   location              .gaps</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Bokeo                 FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Champasak             FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> LouangNamtha          FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Oudomxai              FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Savannakhet           FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Vientiane[prefecture] FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> Xiangkhoang           FALSE</span></span>
<span></span>
<span><span class="co"># Count gaps per location</span></span>
<span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/count_gaps.html" class="external-link">count_gaps</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 0 × 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4 variables: location &lt;chr&gt;, .from &lt;mth&gt;, .to &lt;mth&gt;, .n &lt;int&gt;</span></span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># If there were gaps, fill them:</span></span>
<span><span class="va">filled_data</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/fill_gaps.html" class="external-link">fill_gaps</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/group_by_key.html" class="external-link">group_by_key</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html" class="external-link">fill</a></span><span class="op">(</span><span class="va">disease_cases</span>, .direction <span class="op">=</span> <span class="st">"down"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="temporal-aggregation-with-fabletools">Temporal Aggregation with fabletools<a class="anchor" aria-label="anchor" href="#temporal-aggregation-with-fabletools"></a>
</h2>
<div class="section level3">
<h3 id="aggregate-to-quarterly-data">Aggregate to Quarterly Data<a class="anchor" aria-label="anchor" href="#aggregate-to-quarterly-data"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fabletools.tidyverts.org/" class="external-link">fabletools</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert monthly to quarterly</span></span>
<span><span class="va">quarterly_data</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/index-by.html" class="external-link">index_by</a></span><span class="op">(</span>quarter <span class="op">=</span> <span class="fu"><a href="https://tsibble.tidyverts.org/reference/year-quarter.html" class="external-link">yearquarter</a></span><span class="op">(</span><span class="va">time_period</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">location</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    disease_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">disease_cases</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    rainfall <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rainfall</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    mean_temperature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mean_temperature</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">population</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">quarterly_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 357 x 6 [1Q]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:       location [7]</span></span></span>
<span><span class="co">#&gt;    location quarter disease_cases rainfall mean_temperature population</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;qtr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Bokeo    2000 Q3             0    339.              23.3     <span style="text-decoration: underline;">58</span>503.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Bokeo    2000 Q4             0     49.7             20.7     <span style="text-decoration: underline;">58</span>503.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Bokeo    2001 Q1             0     49.4             21.4     <span style="text-decoration: underline;">60</span>157.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Bokeo    2001 Q2             1    253.              24.8     <span style="text-decoration: underline;">60</span>157.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Bokeo    2001 Q3             3    337.              23.5     <span style="text-decoration: underline;">60</span>157.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Bokeo    2001 Q4             1     67.2             19.9     <span style="text-decoration: underline;">60</span>157.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Bokeo    2002 Q1             0     33.0             21.0     <span style="text-decoration: underline;">61</span>812.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Bokeo    2002 Q2             2    276.              24.6     <span style="text-decoration: underline;">61</span>812.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Bokeo    2002 Q3             1    370.              23.2     <span style="text-decoration: underline;">61</span>812.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Bokeo    2002 Q4             1    107.              20.0     <span style="text-decoration: underline;">61</span>812.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 347 more rows</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aggregate-to-yearly-data">Aggregate to Yearly Data<a class="anchor" aria-label="anchor" href="#aggregate-to-yearly-data"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yearly_data</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">time_period</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">location</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    total_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">disease_cases</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    mean_rainfall <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rainfall</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">yearly_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 98 × 4</span></span></span>
<span><span class="co">#&gt;    location  year total_cases mean_rainfall</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Bokeo     <span style="text-decoration: underline;">2</span>000           0          194.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Bokeo     <span style="text-decoration: underline;">2</span>001           5          177.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Bokeo     <span style="text-decoration: underline;">2</span>002           4          197.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Bokeo     <span style="text-decoration: underline;">2</span>003          20          147.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Bokeo     <span style="text-decoration: underline;">2</span>004           0          185.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Bokeo     <span style="text-decoration: underline;">2</span>005           4          175.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Bokeo     <span style="text-decoration: underline;">2</span>006           6          173.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Bokeo     <span style="text-decoration: underline;">2</span>007           1          170.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Bokeo     <span style="text-decoration: underline;">2</span>008         218          205.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Bokeo     <span style="text-decoration: underline;">2</span>009         709          160.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 88 more rows</span></span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="spatial-aggregation">Spatial Aggregation<a class="anchor" aria-label="anchor" href="#spatial-aggregation"></a>
</h2>
<div class="section level3">
<h3 id="aggregate-across-locations">Aggregate Across Locations<a class="anchor" aria-label="anchor" href="#aggregate-across-locations"></a>
</h3>
<p>Sometimes you need national-level totals from regional data:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Aggregate all locations to national level</span></span>
<span><span class="va">national_data</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">time_period</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    total_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">disease_cases</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">population</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    mean_rainfall <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">rainfall</span>, <span class="va">population</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    mean_temperature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">mean_temperature</span>, <span class="va">population</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">national_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 5</span></span></span>
<span><span class="co">#&gt;    time_period total_cases total_population mean_rainfall mean_temperature</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;mth&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    2000 Jul         159         2<span style="text-decoration: underline;">269</span>893.        389.               24.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    2000 Aug         135         2<span style="text-decoration: underline;">269</span>893.        380.               24.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    2000 Sep         124         2<span style="text-decoration: underline;">269</span>893.        294.               23.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    2000 Oct          87         2<span style="text-decoration: underline;">269</span>893.        143.               23.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    2000 Nov          31         2<span style="text-decoration: underline;">269</span>893.         22.4              21.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    2000 Dec          25         2<span style="text-decoration: underline;">269</span>893.         12.3              21.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    2001 Jan          11         2<span style="text-decoration: underline;">304</span>144.         11.7              22.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    2001 Feb          19         2<span style="text-decoration: underline;">304</span>144.          8.11             23.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    2001 Mar          37         2<span style="text-decoration: underline;">304</span>144.        119.               24.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    2001 Apr          36         2<span style="text-decoration: underline;">304</span>144.         54.6              27.5</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="hierarchical-aggregation">Hierarchical Aggregation<a class="anchor" aria-label="anchor" href="#hierarchical-aggregation"></a>
</h3>
<p>Create data at multiple levels for hierarchical forecasting:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Assume we have a parent column for regional grouping</span></span>
<span><span class="co"># Create hierarchical structure</span></span>
<span><span class="va">hierarchical_data</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">time_period</span>, <span class="va">parent</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    regional_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">disease_cases</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    regional_pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">population</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">hierarchical_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 4</span></span></span>
<span><span class="co">#&gt;    time_period parent regional_cases regional_pop</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;mth&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    2000 Jul -                 159     2<span style="text-decoration: underline;">269</span>893.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    2000 Aug -                 135     2<span style="text-decoration: underline;">269</span>893.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    2000 Sep -                 124     2<span style="text-decoration: underline;">269</span>893.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    2000 Oct -                  87     2<span style="text-decoration: underline;">269</span>893.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    2000 Nov -                  31     2<span style="text-decoration: underline;">269</span>893.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    2000 Dec -                  25     2<span style="text-decoration: underline;">269</span>893.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    2001 Jan -                  11     2<span style="text-decoration: underline;">304</span>144.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    2001 Feb -                  19     2<span style="text-decoration: underline;">304</span>144.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    2001 Mar -                  37     2<span style="text-decoration: underline;">304</span>144.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    2001 Apr -                  36     2<span style="text-decoration: underline;">304</span>144.</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="working-with-spatial-data-sf">Working with Spatial Data (sf)<a class="anchor" aria-label="anchor" href="#working-with-spatial-data-sf"></a>
</h2>
<p>If your data includes geographic coordinates or boundaries:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example: Create spatial features from coordinates</span></span>
<span><span class="va">locations_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Bokeo"</span>, <span class="st">"Luangprabang"</span>, <span class="st">"Oudomxay"</span><span class="op">)</span>,</span>
<span>  lon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100.5</span>, <span class="fl">102.1</span>, <span class="fl">101.5</span><span class="op">)</span>,</span>
<span>  lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20.2</span>, <span class="fl">19.9</span>, <span class="fl">20.7</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Spatial join with administrative boundaries</span></span>
<span><span class="co"># admin_boundaries &lt;- st_read("boundaries.geojson")</span></span>
<span><span class="co"># joined &lt;- st_join(locations_sf, admin_boundaries)</span></span>
<span></span>
<span><span class="co"># Calculate distances between locations</span></span>
<span><span class="co"># distances &lt;- st_distance(locations_sf)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="spatio-temporal-data-with-cubble">Spatio-Temporal Data with cubble<a class="anchor" aria-label="anchor" href="#spatio-temporal-data-with-cubble"></a>
</h2>
<p>For more complex spatio-temporal analyses, the cubble package
provides a unified structure:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/huizezhang-sherry/cubble" class="external-link">cubble</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a cubble from separate spatial and temporal data</span></span>
<span><span class="va">cb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://huizezhang-sherry.github.io/cubble/reference/as_cubble.html" class="external-link">as_cubble</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">training_data</span>,</span>
<span>  key <span class="op">=</span> <span class="va">location</span>,</span>
<span>  index <span class="op">=</span> <span class="va">time_period</span>,</span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span>  <span class="co"># if coordinates available</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Switch between spatial and temporal views</span></span>
<span><span class="va">cb_temporal</span> <span class="op">&lt;-</span> <span class="va">cb</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://huizezhang-sherry.github.io/cubble/reference/face.html" class="external-link">face_temporal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cb_spatial</span> <span class="op">&lt;-</span> <span class="va">cb</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://huizezhang-sherry.github.io/cubble/reference/face.html" class="external-link">face_spatial</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Useful for linking maps with time series plots</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="feature-engineering-for-chap-models">Feature Engineering for CHAP Models<a class="anchor" aria-label="anchor" href="#feature-engineering-for-chap-models"></a>
</h2>
<p>Here’s a complete example of preparing features for a CHAP model:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepare_features</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tsibble.tidyverts.org/reference/group_by_key.html" class="external-link">group_by_key</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      <span class="co"># Lag features</span></span>
<span>      cases_lag1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      cases_lag2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      cases_lag3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>      rainfall_lag1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">rainfall</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span></span>
<span>      <span class="co"># Rolling statistics</span></span>
<span>      cases_ma3 <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html" class="external-link">slide_dbl</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="va">mean</span>, .before <span class="op">=</span> <span class="fl">2</span>, .complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      rainfall_ma3 <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html" class="external-link">slide_dbl</a></span><span class="op">(</span><span class="va">rainfall</span>, <span class="va">mean</span>, .before <span class="op">=</span> <span class="fl">2</span>, .complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span></span>
<span>      <span class="co"># Seasonal features</span></span>
<span>      month <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">time_period</span><span class="op">)</span>,</span>
<span></span>
<span>      <span class="co"># Year-over-year change</span></span>
<span>      cases_yoy <span class="op">=</span> <span class="va">disease_cases</span> <span class="op">-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">12</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Remove rows with NA from lagging</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">cases_lag3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Apply to training data</span></span>
<span><span class="va">features</span> <span class="op">&lt;-</span> <span class="fu">prepare_features</span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span><span class="va">features</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_period</span>, <span class="va">location</span>, <span class="va">disease_cases</span>, <span class="va">cases_lag1</span>, <span class="va">cases_ma3</span>, <span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 10 x 6 [1M]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:       location [1]</span></span></span>
<span><span class="co">#&gt;    time_period location disease_cases cases_lag1 cases_ma3 month</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;mth&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    2000 Oct Bokeo                0          0     0        10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    2000 Nov Bokeo                0          0     0        11</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    2000 Dec Bokeo                0          0     0        12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    2001 Jan Bokeo                0          0     0         1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    2001 Feb Bokeo                0          0     0         2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    2001 Mar Bokeo                0          0     0         3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    2001 Apr Bokeo                0          0     0         4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    2001 May Bokeo                0          0     0         5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    2001 Jun Bokeo                1          0     0.333     6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    2001 Jul Bokeo                1          1     0.667     7</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-features-in-a-chap-model">Using Features in a CHAP Model<a class="anchor" aria-label="anchor" href="#using-features-in-a-chap-model"></a>
</h2>
<p>Here’s a complete example using lag features, validated against the
Laos dataset:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a model that uses lag features</span></span>
<span><span class="va">train_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">training_data</span>, <span class="va">model_configuration</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Calculate mean and use lagged values for adjustment</span></span>
<span>  <span class="va">location_stats</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">location</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>      mean_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">disease_cases</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>location_stats <span class="op">=</span> <span class="va">location_stats</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">predict_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">historic_data</span>, <span class="va">future_data</span>, <span class="va">saved_model</span>,</span>
<span>                       <span class="va">model_configuration</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get the last observed value per location from historic data</span></span>
<span>  <span class="va">last_obs</span> <span class="op">&lt;-</span> <span class="va">historic_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">location</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">time_period</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">location</span>, last_cases <span class="op">=</span> <span class="va">disease_cases</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Blend historical mean with last observation</span></span>
<span>  <span class="va">future_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">saved_model</span><span class="op">$</span><span class="va">location_stats</span>, by <span class="op">=</span> <span class="st">"location"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">last_obs</span>, by <span class="op">=</span> <span class="st">"location"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      <span class="co"># Simple blend: 70% mean + 30% last observation</span></span>
<span>      prediction <span class="op">=</span> <span class="fl">0.7</span> <span class="op">*</span> <span class="va">mean_cases</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">last_cases</span>, <span class="va">mean_cases</span><span class="op">)</span>,</span>
<span>      samples <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">prediction</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">mean_cases</span>, <span class="op">-</span><span class="va">last_cases</span>, <span class="op">-</span><span class="va">prediction</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Validate on Laos dataset</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_example_data.html">get_example_data</a></span><span class="op">(</span><span class="st">'laos'</span>, <span class="st">'M'</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate_model_io.html">validate_model_io</a></span><span class="op">(</span><span class="va">train_fn</span>, <span class="va">predict_fn</span>, <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">success</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">n_predictions</span></span>
<span><span class="co">#&gt; [1] 21</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">n_samples</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>The validation confirms our model produces the correct output
structure.</p>
<div class="section level3">
<h3 id="a-more-complex-example-with-rolling-features">A More Complex Example with Rolling Features<a class="anchor" aria-label="anchor" href="#a-more-complex-example-with-rolling-features"></a>
</h3>
<p>For models using rolling window features (requires the slider
package):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">training_data</span>, <span class="va">model_configuration</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Prepare features with rolling statistics</span></span>
<span>  <span class="va">features</span> <span class="op">&lt;-</span> <span class="va">training_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tsibble.tidyverts.org/reference/group_by_key.html" class="external-link">group_by_key</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      cases_lag1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      cases_ma3 <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html" class="external-link">slide_dbl</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="va">mean</span>, .before <span class="op">=</span> <span class="fl">2</span>, .complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      rainfall_lag1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">rainfall</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">cases_ma3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Fit a simple linear model per location</span></span>
<span>  <span class="va">models</span> <span class="op">&lt;-</span> <span class="va">features</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">location</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_map.html" class="external-link">group_map</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">disease_cases</span> <span class="op">~</span> <span class="va">cases_lag1</span> <span class="op">+</span> <span class="va">cases_ma3</span> <span class="op">+</span> <span class="va">rainfall_lag1</span>, data <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">features</span><span class="op">$</span><span class="va">location</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">models</span>, feature_means <span class="op">=</span> <span class="va">features</span> <span class="op">|&gt;</span></span>
<span>         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cases_lag1</span>, <span class="va">cases_ma3</span>, <span class="va">rainfall_lag1</span><span class="op">)</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">predict_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">historic_data</span>, <span class="va">future_data</span>, <span class="va">saved_model</span>,</span>
<span>                       <span class="va">model_configuration</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get the last known feature values from historic data</span></span>
<span>  <span class="va">last_features</span> <span class="op">&lt;-</span> <span class="va">historic_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tsibble.tidyverts.org/reference/group_by_key.html" class="external-link">group_by_key</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      cases_lag1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      cases_ma3 <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html" class="external-link">slide_dbl</a></span><span class="op">(</span><span class="va">disease_cases</span>, <span class="va">mean</span>, .before <span class="op">=</span> <span class="fl">2</span>, .complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      rainfall_lag1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">rainfall</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">time_period</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">location</span>, <span class="va">cases_lag1</span>, <span class="va">cases_ma3</span>, <span class="va">rainfall_lag1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Generate predictions</span></span>
<span>  <span class="va">future_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">last_features</span>, by <span class="op">=</span> <span class="st">"location"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">saved_model</span><span class="op">$</span><span class="va">models</span><span class="op">[[</span><span class="va">location</span><span class="op">]</span><span class="op">]</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pick.html" class="external-link">pick</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      samples <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">pred</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Ensure non-negative</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">pred</span>, <span class="op">-</span><span class="va">cases_lag1</span>, <span class="op">-</span><span class="va">cases_ma3</span>, <span class="op">-</span><span class="va">rainfall_lag1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>For spatio-temporal data in CHAP:</p>
<ol style="list-style-type: decimal">
<li>
<strong>tsibble</strong> - Use for all temporal data structures and
operations</li>
<li>
<strong>fabletools</strong> - Use for temporal aggregation and
hierarchical forecasting</li>
<li>
<strong>sf</strong> - Use for spatial operations (joins, distances,
boundaries)</li>
<li>
<strong>cubble</strong> - Use for complex spatio-temporal analysis
with linked views</li>
<li>
<strong>slider</strong> - Use for rolling window calculations</li>
</ol>
<p>These packages integrate seamlessly with the tidyverse and work well
with the CHAP SDK’s tsibble-based data format.</p>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li><a href="https://tsibble.tidyverts.org/" class="external-link">tsibble
documentation</a></li>
<li><a href="https://fabletools.tidyverts.org/" class="external-link">fabletools
reference</a></li>
<li><a href="https://r-spatial.github.io/sf/" class="external-link">sf package</a></li>
<li><a href="https://www.jstatsoft.org/article/view/v110i07" class="external-link">cubble
paper (Journal of Statistical Software)</a></li>
<li><a href="https://cran.r-project.org/view=SpatioTemporal" class="external-link">CRAN Task
View: Spatio-Temporal Data</a></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Knut Rand.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>

# Chap R SDK

This package provides convenience functionality for developing CHAP
models and integrating existing models with CHAP.

## Features

- **CLI Interface Generator**: Create CHAP-compatible command line
  interfaces from functions fulfilling the CHAP interface
  - `train(training_data, model_configuration) -> saved_model`
  - `predict(historic_data, future_data, saved_model, model_configuration)`
- **Test Suite**: Sanity check models to ensure prediction output is
  consistent with CHAP expectations
- **Configuration Management**: Expose model configuration schemas to
  CHAP
- **Data Transformations**: Common functionality for extracting and
  transforming spatio-temporal data

The package is tidyverse-oriented and follows best practices in R
development.

## Installation

### Development Version (from GitHub)

You can install the development version of chap.r.sdk from GitHub:

``` r
# Using remotes (recommended)
install.packages("remotes")
remotes::install_github("knutdrand/chap_r_sdk")

# Or using devtools
install.packages("devtools")
devtools::install_github("knutdrand/chap_r_sdk")
```

### CRAN Version (Coming Soon)

Once published on CRAN, you’ll be able to install with:

``` r
install.packages("chap.r.sdk")
```

## Quick Start

### Example: Mean Model

The SDK includes a simple mean model as a reference implementation. This
model predicts the mean disease cases for each location based on
historical data.

#### Using the R Functions

``` r
library(chapr)
library(tsibble)
library(dplyr)

# Load and prepare training data
training_data <- read.csv("inst/testdata/ewars_example/monthly/training_data.csv") |>
  mutate(time_period = yearmonth(time_period)) |>
  as_tsibble(index = time_period, key = location)

# Train the model
model <- train_mean_model(training_data, model_config = list())

# Load future data for prediction
future_data <- read.csv("inst/testdata/ewars_example/monthly/future_data.csv") |>
  mutate(time_period = yearmonth(time_period)) |>
  as_tsibble(index = time_period, key = location)

# Generate predictions
predictions <- predict_mean_model(
  historic_data = NULL,  # Not used by mean model
  future_data = future_data,
  model = model,
  model_config = list()
)
```

#### Using the CLI

The SDK provides command-line scripts for training and prediction:

``` bash
# Train a model
Rscript inst/scripts/train_cli.R \
  --data inst/testdata/ewars_example/monthly/training_data.csv \
  --config inst/testdata/ewars_example/monthly/config.yaml \
  --output model.rds

# Generate predictions
Rscript inst/scripts/predict_cli.R \
  --model model.rds \
  --historic inst/testdata/ewars_example/monthly/historic_data.csv \
  --future inst/testdata/ewars_example/monthly/future_data.csv \
  --output predictions.csv
```

See `examples/test_mean_model.sh` for a complete working example.

## Data Format

### Training Data

Training data should be provided as a tsibble with the following
columns:

- `time_period`: Temporal index (yearmonth for monthly data, yearweek
  for weekly)
- `location`: Spatial key (location name)
- `disease_cases`: Target variable (number of disease cases)
- Additional covariates (e.g., `rainfall`, `mean_temperature`,
  `population`)

Example:

``` csv
time_period,location,disease_cases,rainfall,mean_temperature,population
2000-07,Bokeo,0.0,430.119,23.44,58502.77
2000-08,Bokeo,0.0,321.913,23.82,58502.77
```

### Future Data

Future data should have the same structure but without the
`disease_cases` column:

``` csv
time_period,location,rainfall,mean_temperature,population
2013-04,Bokeo,39.474,26.8,80013.60
2013-05,Bokeo,170.046,25.85,80013.60
```

### Prediction Output

Predictions are returned as a tsibble with the same structure as
training data, including the predicted `disease_cases` column.

## Model Interface

All CHAP models should implement two functions:

### Train Function

``` r
train_model <- function(training_data, model_config) {
  # training_data: tsibble with historical disease cases and covariates
  # model_config: list with model configuration options

  # Train your model here

  # Return model object
  return(model)
}
```

### Predict Function

``` r
predict_model <- function(historic_data, future_data, model, model_config) {
  # historic_data: tsibble with recent historical data
  # future_data: tsibble with future time periods and covariates
  # model: trained model object
  # model_config: list with model configuration options

  # Generate predictions

  # Return tsibble with predictions
  return(predictions)
}
```

## Configuration Files

Model configurations can be provided as YAML or JSON files:

``` yaml
# config.yaml
additional_continuous_covariates: []
user_option_values:
  chap__covid_mask: true
```

## Architecture Decisions

See the `docs/decisions/` directory for Architecture Decision Records
(ADRs) documenting key technical decisions:

- [ADR 001: CLI Interface
  Approach](https://knutdrand.github.io/chap_r_sdk/docs/decisions/001-cli-interface-approach.md) -
  Why we use `optparse` for command-line interfaces

## Development

### Project Structure

    chap_r_sdk/
    ├── R/                      # R package code
    │   ├── mean_model.R        # Example mean model implementation
    │   ├── cli.R              # CLI helper functions
    │   ├── config.R           # Configuration management
    │   ├── validation.R       # Model validation utilities
    │   └── spatial_temporal.R # Data transformation utilities
    ├── inst/
    │   ├── scripts/           # CLI scripts
    │   │   ├── train_cli.R    # Training CLI
    │   │   └── predict_cli.R  # Prediction CLI
    │   └── testdata/          # Test datasets
    ├── tests/                 # Unit tests
    ├── examples/              # Example scripts
    ├── docs/
    │   └── decisions/         # Architecture Decision Records
    └── README.md

### Running Tests

``` r
devtools::test()
```

### Building Documentation

``` r
devtools::document()
pkgdown::build_site()
```

## Related Jira Epic

This project is tracked in Jira: [CLIM-201 - CHAP R SDK
Development](https://dhis2.atlassian.net/browse/CLIM-201)

## Contributing

Contributions are welcome! Please follow R package development best
practices and tidyverse style guidelines.

## License

See LICENSE file for details.

# Package index

## CLI Interface

Create command-line interfaces for CHAP models

- [`create_chap_cli()`](https://knutdrand.github.io/chap_r_sdk/reference/create_chap_cli.md)
  : Create Unified CHAP CLI

## Configuration

Model configuration management

- [`read_model_config()`](https://knutdrand.github.io/chap_r_sdk/reference/read_model_config.md)
  : Read Model Configuration
- [`write_model_config()`](https://knutdrand.github.io/chap_r_sdk/reference/write_model_config.md)
  : Write Model Configuration
- [`get_config_param()`](https://knutdrand.github.io/chap_r_sdk/reference/get_config_param.md)
  : Get Configuration Parameter
- [`create_config_schema()`](https://knutdrand.github.io/chap_r_sdk/reference/create_config_schema.md)
  : Expose Model Configuration Schema
- [`validate_config()`](https://knutdrand.github.io/chap_r_sdk/reference/validate_config.md)
  : Validate Model Configuration

## Model Validation

Test and validate CHAP model implementations

- [`run_model_tests()`](https://knutdrand.github.io/chap_r_sdk/reference/run_model_tests.md)
  : Run Model Test Suite
- [`validate_model_io()`](https://knutdrand.github.io/chap_r_sdk/reference/validate_model_io.md)
  : Validate Model Input/Output with Example Data
- [`validate_model_io_all()`](https://knutdrand.github.io/chap_r_sdk/reference/validate_model_io_all.md)
  : Validate Model Input/Output for All Available Datasets
- [`validate_model_output()`](https://knutdrand.github.io/chap_r_sdk/reference/validate_model_output.md)
  : Validate Model Output

## Spatio-Temporal Data

Utilities for working with spatio-temporal data

- [`transform_spatiotemporal()`](https://knutdrand.github.io/chap_r_sdk/reference/transform_spatiotemporal.md)
  : Transform Spatio-Temporal Data
- [`aggregate_spatial()`](https://knutdrand.github.io/chap_r_sdk/reference/aggregate_spatial.md)
  : Aggregate Spatial Data
- [`aggregate_temporal()`](https://knutdrand.github.io/chap_r_sdk/reference/aggregate_temporal.md)
  : Aggregate Temporal Data

## Prediction Samples

Convert between prediction sample formats

- [`predictions_from_wide()`](https://knutdrand.github.io/chap_r_sdk/reference/predictions_from_wide.md)
  : Convert Wide Format Predictions to Nested Format
- [`predictions_to_wide()`](https://knutdrand.github.io/chap_r_sdk/reference/predictions_to_wide.md)
  : Convert Nested Format Predictions to Wide Format
- [`predictions_from_long()`](https://knutdrand.github.io/chap_r_sdk/reference/predictions_from_long.md)
  : Convert Long Format to Nested Format
- [`predictions_to_long()`](https://knutdrand.github.io/chap_r_sdk/reference/predictions_to_long.md)
  : Convert Nested Format to Long Format
- [`predictions_to_quantiles()`](https://knutdrand.github.io/chap_r_sdk/reference/predictions_to_quantiles.md)
  : Compute Quantiles from Prediction Samples
- [`predictions_summary()`](https://knutdrand.github.io/chap_r_sdk/reference/predictions_summary.md)
  : Add Summary Statistics to Predictions
- [`has_prediction_samples()`](https://knutdrand.github.io/chap_r_sdk/reference/has_prediction_samples.md)
  : Check if Predictions Have Samples
- [`detect_prediction_format()`](https://knutdrand.github.io/chap_r_sdk/reference/detect_prediction_format.md)
  : Detect Prediction Sample Format

## Example Models

Reference model implementations

- [`train_mean_model()`](https://knutdrand.github.io/chap_r_sdk/reference/train_mean_model.md)
  : Train a simple mean model
- [`predict_mean_model()`](https://knutdrand.github.io/chap_r_sdk/reference/predict_mean_model.md)
  : Predict using mean model

## Utilities

Helper functions

- [`get_example_data()`](https://knutdrand.github.io/chap_r_sdk/reference/get_example_data.md)
  : Get Example Data for Testing

# Articles

### Getting Started

- [Getting Started with
  chap.r.sdk](https://knutdrand.github.io/chap_r_sdk/articles/getting-started.md):

### Tutorials

- [Building Your First CHAP
  Model](https://knutdrand.github.io/chap_r_sdk/articles/model-development-tutorial.md):
